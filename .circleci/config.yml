# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

executors:
  vm-executor:
    machine:
      enabled: true
      image: ubuntu-1604:201903-01
    working_directory: ~/repo
    environment:
      shell: /bin/bash
      TERM: xterm
      TZ: "Europe/Berlin"

workflows:
  test-workflow:
    jobs:
      - test-job

commands:
  say-hello-to-ssh:
    description: "Say hello with ssh"
    steps:
      - add_ssh_keys:
          fingerprints:
            - "ba:fc:ed:ea:ba:be:ce:75:a8:cf:11:bb:99:9d:d2:54"
      - run:
          shell: /bin/bash
          name: Clone Repository
          command: >-
            ssh arkocal@82.165.71.183 "echo Building all on external server &&
            echo ${CIRCLE_REPOSITORY_URL} &&
            mkdir /tmp/${CIRCLE_PROJECT_REPONAME}-${CIRCLE_BUILD_NUM} &&
            cd /tmp/${CIRCLE_PROJECT_REPONAME}-${CIRCLE_BUILD_NUM} &&
            git clone ${CIRCLE_REPOSITORY_URL} -b ${CIRCLE_BRANCH} &&
            cd /tmp/${CIRCLE_PROJECT_REPONAME}-${CIRCLE_BUILD_NUM}/${CIRCLE_PROJECT_REPONAME}/ &&
            git submodule init &&
            git submodule update &&
            make update TERM=xterm"
      - run:
          shell: /bin/bash
          name: Build
          command: >-
            export TEST_ID=${CIRCLE_PROJECT_REPONAME}-${CIRCLE_BUILD_NUM} &&
            ssh arkocal@82.165.71.183
            "cd /tmp/${TEST_ID}/${CIRCLE_PROJECT_REPONAME} &&
            yes | make build DOCKER_TAG=test_${TEST_ID} DEBUG=true TERM=xterm"
      - run:
          shell: /bin/bash
          name: Test
# export DOCKERUSER=$DOCKERUSER passes the local variable to remote connection.
          command: >-
            export TEST_ID=${CIRCLE_PROJECT_REPONAME}-${CIRCLE_BUILD_NUM} &&
            ssh arkocal@82.165.71.183
            "cd /tmp/${TEST_ID}/${CIRCLE_PROJECT_REPONAME} &&
            export NAMESPACE=${TEST_ID} &&
            export NODOCKERLOGIN=true &&
            export KUBECONFIG=\$(k3d get-kubeconfig) &&
            sh util/deploy_operators.sh &&
            make import-images-to-local-registry DOCKER_TAG=test_${TEST_ID} DEBUG=true &&
            (make undeploy-oisp || true) &&
            make deploy-oisp-test DOCKER_TAG=test_${TEST_ID} HELM_ARGS=\"--set use_local_registry=true\" &&
            make test &&
            make undeploy-oisp"
jobs:
  test-job:
    executor: vm-executor
    steps:
      - say-hello-to-ssh
